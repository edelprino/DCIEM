    ! FILE D6S - BASIC 6S MODEL WITH RAMP DESCENT (WITH ALTITUDE CALCULATIONS)

PROGRAM DCIEM_MAIN
    CHARACTER*5 INDATA(2), OUTDAT(2)
    LOGICAL FOUND,C,KTEST
    COMMON TITL(14), P(4), G(4), GBIG(4), AK(4,4), F(5)
    DATA INDATA(1), INDATA(2) / 'NLDIV', ' SRC' /
    DATA OUTDAT(1), OUTDAT(2) / 'NLDIV', ' LST' /
    DATA Z1, Z2, Z3 /.207106781, .292893219, .707106781/
    DATA Z4, Z5, Z6/1.707106781, .585786433, 5.414213562/

    ! OPEN DATA FILE

    OPEN(UNIT=3, FILE='NLDIV.SRC', STATUS='OLD', IOSTAT=IERR)
    IF (IERR /= 0) THEN
        WRITE(*,*) 'Error opening input file'
        STOP
    END IF
    
    OPEN(UNIT=7, FILE='NLDIV.LST', STATUS='REPLACE')
    
    READ (3,101) KEY, TITL
101 FORMAT (I2, 14A5)
    IF (KEY.NE.9) GO TO 2
    CLOSE(3)
    CLOSE(7)
    STOP

2   WRITE (7,102) TITL
102 FORMAT (1H1,14A5)
    READ(3,103) A,B,R
103 FORMAT(E8.4,F5.1,F5.3)
    READ(3,112) DTL,TMAX,PTOUT,RDES,RASC
112 FORMAT(5F4.1)
    WRITE (7,103) A, B, R, DTL
108 FORMAT('0',4X,'A = ',F9.8,5X,'B = ',F5.1,5X,'R = ',F5.3,/,'0',3X,'MAX STEP TIME = ',F4.2,' MIN')
    IF (KEY.EQ.4) GO TO 125
    WRITE (7,120) RASC,RDES
120 FORMAT(4X,'ASC = ',F5.1,' FT/MIN',6X,'DESC = ',F5.1,' FT/MIN/')
125 KTEST=5*(KEY/5).EQ.KEY
    TMAX1=TMAX
    WRITE (7,109)
109 FORMAT('0', ' TOTAL DIVE ACTUAL ALTITUDE', &
    6X,'SAFE ASCENT DEPTHS (FT OF SEAWATER)', &
    2X,'TIME (MIN)', &
    21X,'DEPTH (FT) (1000 FT)',9X,'1',8X,'2',8X,'3',8X,'4'/)
    DTI=DTL * .1

! INITIAL TIME AND PRESSURES

6   READ (3,104) T, G1,G2,G3,G4
104 FORMAT(F65.1)
    K = 1
    FOUND = G(1).EQ.0.
    DO I=1,4
        IF (FOUND) G(I) = G1
        P(I) = G(I) + 33.
        W = P(I)/R - 42.9
        GBIG(I) = W
        IF (GBIG(K).LT.W) K = I
    END DO

    PI = G1 + 33.
    PBIGK=GBIG(K) + 33.
    TT = T
    C = .FALSE.
    NS3 = 5
    GO TO 30
25  PMIN = 0.
    KPT = 0

! READ IN STEP TIME AND PRESSURES

11  DT = DTL 
    PLAST = PI 
    READ (3,104) T, GI 
    IF (T.LT.0.) GO TO 12 
    IF(NS2.EQ.2) T=T+TT 
    NS2 = 1
    TL = T - .01 
    IF (KEY.EQ.4) GO TO 59 
    DP = .1+RDES 
    W2 = GI + 33. - DP ! GI da controllare (non si capisce bene da pdf)
56  IF (PI.LT.W2) GO TO 58 
59  P1 = GI+33. 
    NS = 5 
    GO TO 57 
58  DT=0.1 
    NS=1 
    P1 = P1+DP




12 CONTINUE ! PLACEHOLDER
57  CONTINUE ! PLACEHOLDER
30  CONTINUE  ! DA RIMUOVERE, SOLO PER COMPILARE TEMPORANEAMENTE, AGGGIUNTA IO

END PROGRAM DCIEM_MAIN